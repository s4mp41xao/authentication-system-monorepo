/**
 * Script para popular o banco de dados com dados de teste
 * Execute com: npx tsx scripts/seed-database.ts
 */

import { MongoClient, ObjectId } from 'mongodb';
import * as dotenv from 'dotenv';

dotenv.config();

async function seedDatabase() {
  const client = new MongoClient(process.env.DATABASE_URL!);

  try {
    console.log('üöÄ Conectando ao MongoDB...\n');
    await client.connect();
    const db = client.db();

    console.log('üóëÔ∏è  LIMPANDO TODOS OS DADOS (exceto Admin ORI)...');

    // 1. Buscar o ID do admin ORI para preserv√°-lo
    const adminUser = await db.collection('user').findOne({
      email: 'admin@ori.com',
      role: 'ori',
    });

    let adminUserId: string | null = null;
    if (adminUser) {
      adminUserId = adminUser._id.toString();
      console.log(
        `‚úÖ Admin ORI encontrado: ${adminUser.email} (ID: ${adminUserId})`,
      );
    } else {
      console.log('‚ö†Ô∏è  Admin ORI n√£o encontrado no banco');
    }

    // 2. Deletar todas as cole√ß√µes (exceto registros do admin)
    console.log('   ‚Üí Deletando users (exceto ORI)...');
    const deletedUsers = await db.collection('user').deleteMany({
      role: { $ne: 'ori' },
    });
    console.log(`   ‚úì ${deletedUsers.deletedCount} usu√°rios deletados`);

    console.log('   ‚Üí Deletando accounts (exceto ORI)...');
    if (adminUserId) {
      const deletedAccounts = await db.collection('account').deleteMany({
        userId: { $ne: adminUserId },
      });
      console.log(`   ‚úì ${deletedAccounts.deletedCount} contas deletadas`);
    } else {
      const deletedAccounts = await db.collection('account').deleteMany({});
      console.log(`   ‚úì ${deletedAccounts.deletedCount} contas deletadas`);
    }

    console.log('   ‚Üí Deletando sessions (exceto ORI)...');
    if (adminUserId) {
      const deletedSessions = await db.collection('session').deleteMany({
        userId: { $ne: adminUserId },
      });
      console.log(`   ‚úì ${deletedSessions.deletedCount} sess√µes deletadas`);
    } else {
      const deletedSessions = await db.collection('session').deleteMany({});
      console.log(`   ‚úì ${deletedSessions.deletedCount} sess√µes deletadas`);
    }

    console.log('   ‚Üí Deletando influencers...');
    const deletedInfluencers = await db.collection('influencer').deleteMany({});
    console.log(
      `   ‚úì ${deletedInfluencers.deletedCount} influencers deletados`,
    );

    console.log('   ‚Üí Deletando brands...');
    const deletedBrands = await db.collection('brand').deleteMany({});
    console.log(`   ‚úì ${deletedBrands.deletedCount} marcas deletadas`);

    console.log('   ‚Üí Deletando campaigns...');
    const deletedCampaigns = await db.collection('campaign').deleteMany({});
    console.log(`   ‚úì ${deletedCampaigns.deletedCount} campanhas deletadas`);

    console.log('‚úÖ Banco limpo!\n');

    console.log('üìù Criando usu√°rios via API do backend...\n');

    // Usar a API do Vercel em produ√ß√£o
    const API_URL = 'https://authentication-system-monorepo-back.vercel.app';

    // Armazenar IDs dos usu√°rios criados
    const createdInfluencers: Array<{
      id: string;
      email: string;
      name: string;
    }> = [];
    const createdBrands: Array<{ id: string; email: string; name: string }> =
      [];

    // 1. Criar Influencers
    const influencers = [
      {
        email: 'maria.silva@instagram.com',
        password: 'Senha@123',
        name: 'Maria Silva',
        role: 'influencer',
        instagram: '@mariasilva',
        followers: 85000,
        bio: 'Fashion & Lifestyle | üìç S√£o Paulo',
      },
      {
        email: 'joao.santos@tiktok.com',
        password: 'Senha@123',
        name: 'Jo√£o Santos',
        role: 'influencer',
        instagram: '@joaosantos',
        followers: 120000,
        bio: 'Tech Content Creator | Gaming & Reviews',
      },
      {
        email: 'ana.costa@youtube.com',
        password: 'Senha@123',
        name: 'Ana Costa',
        role: 'influencer',
        instagram: '@anacosta',
        followers: 200000,
        bio: 'Travel Vlogger | ‚úàÔ∏è Exploring the World',
      },
      {
        email: 'pedro.oliveira@insta.com',
        password: 'Senha@123',
        name: 'Pedro Oliveira',
        role: 'influencer',
        instagram: '@pedrooliveira',
        followers: 65000,
        bio: 'Fitness Coach | üí™ Healthy Lifestyle',
      },
      {
        email: 'julia.lima@social.com',
        password: 'Senha@123',
        name: 'Julia Lima',
        role: 'influencer',
        instagram: '@julialima',
        followers: 95000,
        bio: 'Beauty & Makeup Artist | ‚ú®',
      },
    ];

    for (const inf of influencers) {
      console.log(`üë§ Criando Influencer: ${inf.name}...`);
      const response = await fetch(`${API_URL}/auth/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(inf),
      });

      if (response.ok) {
        const data = await response.json();
        createdInfluencers.push({
          id: data.user.id,
          email: inf.email,
          name: inf.name,
        });
        console.log(`‚úÖ ${inf.name} criado: ${inf.email} / ${inf.password}`);
      } else {
        const error = await response.text();
        console.log(`‚ö†Ô∏è  ${inf.name}:`, error);
      }
    }
    console.log();

    // 2. Criar Brands
    const brands = [
      {
        email: 'contato@techstyle.com',
        password: 'Senha@123',
        name: 'TechStyle',
        role: 'brand',
        website: 'https://techstyle.com',
        industry: 'Fashion Tech',
        description: 'Moda tecnol√≥gica e inovadora para o p√∫blico jovem',
      },
      {
        email: 'marketing@fitlife.com',
        password: 'Senha@123',
        name: 'FitLife',
        role: 'brand',
        website: 'https://fitlife.com',
        industry: 'Health & Fitness',
        description: 'Produtos e suplementos para vida fitness',
      },
      {
        email: 'contato@beautyco.com',
        password: 'Senha@123',
        name: 'BeautyCo',
        role: 'brand',
        website: 'https://beautyco.com',
        industry: 'Beauty & Cosmetics',
        description: 'Cosm√©ticos premium e cruelty-free',
      },
      {
        email: 'social@travelmore.com',
        password: 'Senha@123',
        name: 'TravelMore',
        role: 'brand',
        website: 'https://travelmore.com',
        industry: 'Travel & Tourism',
        description: 'Ag√™ncia de viagens e experi√™ncias √∫nicas',
      },
      {
        email: 'digital@gamezone.com',
        password: 'Senha@123',
        name: 'GameZone',
        role: 'brand',
        website: 'https://gamezone.com',
        industry: 'Gaming & Entertainment',
        description: 'Loja de games e acess√≥rios gamer',
      },
    ];

    for (const brand of brands) {
      console.log(`üè¢ Criando Brand: ${brand.name}...`);
      const response = await fetch(`${API_URL}/auth/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(brand),
      });

      if (response.ok) {
        const data = await response.json();
        createdBrands.push({
          id: data.user.id,
          email: brand.email,
          name: brand.name,
        });
        console.log(
          `‚úÖ ${brand.name} criado: ${brand.email} / ${brand.password}`,
        );
      } else {
        const error = await response.text();
        console.log(`‚ö†Ô∏è  ${brand.name}:`, error);
      }
    }
    console.log();

    // 3. Criar Campanhas com Influencers Vinculados
    // IMPORTANTE: 3 influencers (Maria, Ana, Jo√£o) aparecem em pelo menos 2 campanhas cada
    console.log('üì¢ Criando 5 campanhas com influencers vinculados...\n');

    const campaigns = [
      {
        brandEmail: 'contato@techstyle.com',
        name: 'Lan√ßamento Cole√ß√£o Primavera 2025',
        description: 'Divulga√ß√£o da nova cole√ß√£o de roupas tech-wear',
        budget: 50000,
        status: 'active',
        startDate: '2025-10-01',
        endDate: '2025-12-31',
        // Maria (1¬™) + Ana (1¬™) + Julia
        influencerEmails: [
          'maria.silva@instagram.com',
          'ana.costa@youtube.com',
          'julia.lima@social.com',
        ],
      },
      {
        brandEmail: 'marketing@fitlife.com',
        name: 'Desafio FitLife 30 Dias',
        description: 'Campanha de engajamento com desafio fitness',
        budget: 35000,
        status: 'active',
        startDate: '2025-10-15',
        endDate: '2025-11-15',
        // Maria (2¬™) + Jo√£o (1¬™) + Pedro
        influencerEmails: [
          'maria.silva@instagram.com',
          'joao.santos@tiktok.com',
          'pedro.oliveira@insta.com',
        ],
      },
      {
        brandEmail: 'contato@beautyco.com',
        name: 'Nova Linha de Maquiagem Vegana',
        description: 'Lan√ßamento de produtos cruelty-free',
        budget: 45000,
        status: 'active',
        startDate: '2025-10-20',
        endDate: '2025-12-20',
        // Ana (2¬™) + Julia
        influencerEmails: ['ana.costa@youtube.com', 'julia.lima@social.com'],
      },
      {
        brandEmail: 'social@travelmore.com',
        name: 'Roteiros Exclusivos Nordeste',
        description:
          'Promo√ß√£o de pacotes tur√≠sticos para o Nordeste brasileiro',
        budget: 60000,
        status: 'active',
        startDate: '2025-11-01',
        endDate: '2026-01-31',
        // Jo√£o (2¬™) + Pedro
        influencerEmails: [
          'joao.santos@tiktok.com',
          'pedro.oliveira@insta.com',
        ],
      },
      {
        brandEmail: 'digital@gamezone.com',
        name: 'Black Friday Gamer 2025',
        description: 'Maior campanha de vendas do ano com descontos exclusivos',
        budget: 80000,
        status: 'active',
        startDate: '2025-11-15',
        endDate: '2025-11-30',
        // Pedro + Julia
        influencerEmails: ['pedro.oliveira@insta.com', 'julia.lima@social.com'],
      },
    ];

    for (const campaign of campaigns) {
      console.log(`üì¢ Criando campanha: ${campaign.name}...`);

      // Buscar brand ID e influencer IDs
      const brandId = createdBrands.find(
        (b) => b.email === campaign.brandEmail,
      )?.id;
      const assignedInfluencers = campaign.influencerEmails
        .map(
          (email) => createdInfluencers.find((inf) => inf.email === email)?.id,
        )
        .filter((id): id is string => id !== undefined);

      const campaignDoc = {
        _id: new ObjectId(),
        name: campaign.name,
        description: campaign.description,
        brandId: brandId,
        budget: campaign.budget,
        status: campaign.status,
        startDate: new Date(campaign.startDate),
        endDate: new Date(campaign.endDate),
        assignedInfluencers,
        createdAt: new Date(),
        updatedAt: new Date(),
      };

      await db.collection('campaign').insertOne(campaignDoc);
      console.log(
        `‚úÖ Campanha criada com ${assignedInfluencers.length} influencers vinculados`,
      );
    }
    console.log();

    // 4. Estat√≠sticas de vincula√ß√£o
    console.log('üìä Estat√≠sticas de vincula√ß√£o de influencers:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

    const influencerStats = new Map<string, number>();
    for (const campaign of campaigns) {
      for (const email of campaign.influencerEmails) {
        influencerStats.set(email, (influencerStats.get(email) || 0) + 1);
      }
    }

    console.log('Influencers em m√∫ltiplas campanhas:');
    influencerStats.forEach((count, email) => {
      const inf = createdInfluencers.find((i) => i.email === email);
      console.log(`   ‚Ä¢ ${inf?.name}: ${count} campanhas`);
    });
    console.log();

    console.log('üìã Resumo das credenciais criadas:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üîë ADMIN ORI:');
    console.log('   Email: admin@ori.com');
    console.log('   Senha: Admin123!');
    console.log();
    console.log('üì± INFLUENCERS:');
    console.log('   1. maria.silva@instagram.com / Senha@123 (2 campanhas)');
    console.log('   2. joao.santos@tiktok.com / Senha@123 (2 campanhas)');
    console.log('   3. ana.costa@youtube.com / Senha@123 (2 campanhas)');
    console.log('   4. pedro.oliveira@insta.com / Senha@123 (3 campanhas)');
    console.log('   5. julia.lima@social.com / Senha@123 (3 campanhas)');
    console.log();
    console.log('üè¢ MARCAS (todas com 1 campanha ativa):');
    console.log('   1. contato@techstyle.com / Senha@123');
    console.log('   2. marketing@fitlife.com / Senha@123');
    console.log('   3. contato@beautyco.com / Senha@123');
    console.log('   4. social@travelmore.com / Senha@123');
    console.log('   5. digital@gamezone.com / Senha@123');
    console.log();
    console.log('üì¢ CAMPANHAS CRIADAS: 5 campanhas ativas');
    console.log(
      '   ‚úÖ 3 influencers em pelo menos 2 campanhas (Maria, Ana, Jo√£o)',
    );
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  } catch (error) {
    console.error('‚ùå Erro:', error);
    throw error;
  } finally {
    await client.close();
    console.log('\nüîå Conex√£o fechada');
  }
}

seedDatabase()
  .then(() => {
    console.log('\n‚ú® Banco populado com sucesso!');
    process.exit(0);
  })
  .catch(() => {
    process.exit(1);
  });
